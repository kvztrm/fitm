-- AutoFish Scanner - Indices 0 to 150 in Folder1/2/3 - Grouped Webhook
-- Full rewrite - no fixed names, pure index-based scan

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 0        -- report any number found (0 and up)
local MAX_INDEX = 150
local SCAN_INTERVAL = 90   -- seconds
local DEBUG = true

-- Folders
local fpp = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)

local folders = {
    Folder1 = fpp:WaitForChild("Folder1", 5),
    Folder2 = fpp:WaitForChild("Folder2", 5),
    Folder3 = fpp:WaitForChild("Folder3", 5)
}

print("[Scanner] Ready - will check indices 0–" .. MAX_INDEX .. " in each folder every " .. SCAN_INTERVAL .. "s")

-- Get text from PPPart_PP
local function readPrompt(part)
    if not part then return nil end

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil end

    return (prompt.ObjectText or "") .. " " .. (prompt.ActionText or "")
end

-- Extract first valid number
local function getNumber(text)
    if not text or text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)",
        "(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local match = clean:match(pat)
        if match then
            local num = tonumber(match)
            if num and num >= THRESHOLD then
                return num
            end
        end
    end

    return nil
end

-- Send webhook (WeAreDevs style)
local function sendWebhook(message)
    local payload = { content = message }

    local success, resp = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)

    if success then
        print("[WEBHOOK OK] Status: " .. (resp.StatusCode or "unknown"))
    else
        warn("[WEBHOOK ERROR] " .. tostring(resp))
    end
end

-- Main scan
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN] Starting full index check...") end

    local found = {}

    for folderName, folder in pairs(folders) do
        if not folder then
            if DEBUG then print("[SKIP] " .. folderName .. " missing") end
            continue
        end

        for i = 0, MAX_INDEX do
            local child = folder:GetChildren()[i + 1]  -- Lua 1-based
            if not child then continue end

            local text = readPrompt(child)
            if text then
                local num = getNumber(text)
                if num then
                    local entry = {
                        folder = folderName,
                        index = i,
                        partName = child.Name or "Index " .. i,
                        value = num
                    }
                    table.insert(found, entry)

                    if DEBUG then
                        print(string.format("[FOUND] %s → Index %d → %s = %d", folderName, i, entry.partName, num))
                    end
                end
            end
        end
    end

    if #found > 0 then
        local lines = {}
        for i, f in ipairs(found) do
            table.insert(lines, string.format("%d. **%s** (Folder %s, Index %d) - **%d**", 
                i, f.partName, f.folder, f.index, f.value))
        end

        local msg = "**Fish Detected (" .. #found .. " total):**\n" .. table.concat(lines, "\n")

        sendWebhook(msg)
    else
        if DEBUG then print("[SCAN] Nothing found this cycle") end
    end

    if DEBUG then print("[SCAN] Done - next in " .. SCAN_INTERVAL .. "s") end
end)

print("[FishScanner] Running - full 0–" .. MAX_INDEX .. " scan in all folders")
