-- AutoFish Notifier - Scan FishPPPart indices 0-150 for enabled "able" property
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"
local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true

-- Get FrameWork_WorkSpace
local workspaceFrame = workspace:WaitForChild("FrameWork_WorkSpace", 10)
if not workspaceFrame then
    error("FrameWork_WorkSpace not found!")
end

-- FishPPPart location
local fishPPPart = workspaceFrame:WaitForChild("FishPPPart", 10)
if not fishPPPart then
    error("FishPPPart folder not found!")
end

-- Get all three folders
local folders = {
    fishPPPart:WaitForChild("Folder1", 10),
    fishPPPart:WaitForChild("Folder2", 10),
    fishPPPart:WaitForChild("Folder3", 10)
}

-- Check if folders exist
for i, folder in ipairs(folders) do
    if not folder then
        error("Folder" .. i .. " not found in FishPPPart!")
    end
end

print("[FishScanner] Found all 3 FishPPPart folders")

-- Your desired fish types (case-insensitive partial match)
local wantedFishTypes = {
    "sea dweller",
    "scp3000", "scp-300", "scp 300", "scp300",
    "plesiosaurus",
    "hammerhead shark", "hammerhead",
    "bloop",
    "el gran maja", "gran maja",
    "julia beast",
    "ningen",
    "megalodon",
    "zombie fish",
    "sea eater",
    "bone shark", "boneshark",
    "shark girl",
    "shark boy",
    "king squid",
    "sea reaper"
}

-- Function to check if fish is wanted
local function isWantedFish(name)
    if not name then return false end
    local lower = name:lower()
    for _, w in ipairs(wantedFishTypes) do
        if lower:find(w:lower(), 1, true) then
            return true
        end
    end
    return false
end

-- Extract percentage from name and action text
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end
    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }
    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end
    return nil
end

-- Check if fish has "able" property enabled
local function isAbleEnabled(fishModel)
    if not fishModel then return false end
    
    -- Check for "able" child object
    local ableChild = fishModel:FindFirstChild("able")
    if ableChild then
        -- Check if it's a BasePart with visible properties
        if ableChild:IsA("BasePart") then
            -- Check transparency and can collide
            if ableChild.Transparency < 1 or ableChild.CanCollide then
                return true
            end
        -- Check if it's a BoolValue
        elseif ableChild:IsA("BoolValue") then
            return ableChild.Value == true
        -- Check if it's a StringValue with "true" or "1"
        elseif ableChild:IsA("StringValue") then
            local val = ableChild.Value:lower()
            return val == "true" or val == "1" or val == "enabled"
        -- Check if it's a NumberValue
        elseif ableChild:IsA("NumberValue") then
            return ableChild.Value > 0
        end
    end
    
    -- Check attributes
    local ableAttr = fishModel:GetAttribute("able")
    if ableAttr ~= nil then
        if type(ableAttr) == "boolean" then
            return ableAttr
        elseif type(ableAttr) == "string" then
            local val = ableAttr:lower()
            return val == "true" or val == "1" or val == "enabled"
        elseif type(ableAttr) == "number" then
            return ableAttr > 0
        end
    end
    
    -- Check if model itself has enabled/visible properties
    if fishModel:IsA("Model") then
        -- Check if PrimaryPart is visible
        if fishModel.PrimaryPart then
            if fishModel.PrimaryPart.Transparency < 1 then
                return true
            end
        end
        
        -- Check if any part is visible
        for _, child in ipairs(fishModel:GetDescendants()) do
            if child:IsA("BasePart") and child.Transparency < 1 then
                return true
            end
        end
    end
    
    return false
end

-- Get fish info from model
local function getFishInfo(fishModel)
    if not fishModel then return nil, nil, nil end
    
    -- Get prompt info
    local prompt = fishModel:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then
        return nil, nil, nil
    end
    
    local name = prompt.ObjectText or fishModel.Name
    local action = prompt.ActionText or ""
    
    -- Check if able is enabled
    local enabled = isAbleEnabled(fishModel)
    
    return name, action, enabled
end

-- Webhook sender
local function SendWebhook(fishName, percent)
    local headers = {["Content-Type"] = "application/json"}
    local message = "**" .. fishName .. "** - **" .. percent .. "%** (able enabled)"
    local payload = {content = message}
    local body = HttpService:JSONEncode(payload)
    
    if DEBUG then print("[WEBHOOK] Sending: " .. message) end
    
    local success, response = pcall(function()
        return HttpService:PostAsync(WEBHOOK_URL, body, Enum.HttpContentType.ApplicationJson)
    end)
    
    if success then
        print("[WEBHOOK] ✓ Sent: " .. fishName .. " @ " .. percent .. "%")
    else
        warn("[WEBHOOK] ✗ Failed: " .. tostring(response))
        
        -- Try request if available
        if request then
            local success2 = pcall(function()
                request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = headers,
                    Body = body
                })
            end)
            if success2 then
                print("[WEBHOOK] ✓ Sent via request")
            end
        end
    end
end

-- Track sent fish to avoid duplicates
local sentFish = {}
local COOLDOWN = 300 -- 5 minutes cooldown

-- Main scan function
local function scanFishPPPart()
    if DEBUG then print("\n" .. string.rep("=", 60)) end
    if DEBUG then print("[SCAN START] Scanning FishPPPart indices 0-150...") end
    
    local totalScanned = 0
    local enabledCount = 0
    local wantedCount = 0
    local sentCount = 0
    
    for folderIndex, folder in ipairs(folders) do
        if DEBUG then print("\n[SCAN] Folder" .. folderIndex .. " (" .. folder.Name .. ")") end
        
        -- Scan indices 0 to 150
        for i = 0, 150 do
            totalScanned = totalScanned + 1
            
            -- Get child at index i
            local children = folder:GetChildren()
            if i + 1 <= #children then
                local fishModel = children[i + 1]
                
                -- Get fish info
                local name, action, enabled = getFishInfo(fishModel)
                
                if name and enabled then
                    enabledCount = enabledCount + 1
                    
                    -- Check if it's a wanted fish
                    if isWantedFish(name) then
                        wantedCount = wantedCount + 1
                        
                        -- Extract percentage
                        local percent = extractPercentage(name, action)
                        if percent then
                            -- Check cooldown
                            local now = tick()
                            local lastSent = sentFish[name] or 0
                            
                            if now - lastSent >= COOLDOWN then
                                if DEBUG then
                                    print("[FOUND] ✓ " .. name .. " @ " .. percent .. "% (Index " .. i .. " in " .. folder.Name .. ")")
                                end
                                
                                -- Send webhook
                                SendWebhook(name, percent)
                                sentFish[name] = now
                                sentCount = sentCount + 1
                            else
                                if DEBUG then
                                    print("[COOLDOWN] " .. name .. " @ " .. percent .. "% (on cooldown)")
                                end
                            end
                        elseif DEBUG then
                            print("[NO-PERCENT] " .. name .. " (no valid percentage)")
                        end
                    elseif DEBUG then
                        print("[NOT-WANTED] " .. name .. " (able enabled)")
                    end
                elseif DEBUG and i % 25 == 0 then
                    -- Print progress every 25 indices
                    print("[PROGRESS] Folder" .. folderIndex .. ": Scanned " .. i .. "/150 indices")
                end
            end
        end
    end
    
    if DEBUG then
        print("\n[SCAN END] Summary:")
        print("  Total indices scanned: " .. totalScanned)
        print("  Models with 'able' enabled: " .. enabledCount)
        print("  Wanted fish enabled: " .. wantedCount)
        print("  Webhooks sent: " .. sentCount)
        print(string.rep("=", 60))
    end
end

-- Start scanning
local lastScan = 0
RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now
    
    scanFishPPPart()
end)

-- Initial info
print("\n[FishScanner] Active!")
print("  • Scanning: FishPPPart.Folder1/2/3")
print("  • Indices: 0 to 150 in each folder")
print("  • Checking: 'able' property enabled")
print("  • Threshold: ≥ " .. THRESHOLD .. "%")
print("  • Cooldown: " .. COOLDOWN .. " seconds per fish")
print("  • Wanted fish types: " .. #wantedFishTypes)

-- Send startup notification
wait(2)
local startupMsg = "**[STARTUP]** FishScanner active! Scanning FishPPPart indices 0-150 for enabled fish."
local payload = {content = startupMsg}
local body = HttpService:JSONEncode(payload)

pcall(function()
    HttpService:PostAsync(WEBHOOK_URL, body, Enum.HttpContentType.ApplicationJson)
    print("[WEBHOOK] Startup message sent")
end)

-- Initial scan
wait(5)
scanFishPPPart()
