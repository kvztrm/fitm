-- AutoFish Notifier - SAFE VERSION - long waits + nil guards everywhere
-- Only your 17 shelf positions - ≥50%

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true

-- Wait longer for everything
print("[INIT] Waiting for FrameWork_WorkSpace (30s)...")
local frameWork = workspace:WaitForChild("FrameWork_WorkSpace", 30)
if not frameWork then warn("[FATAL] FrameWork_WorkSpace missing after 30s") return end

print("[INIT] Waiting for FishPPPart (30s)...")
local fishPPPart = frameWork:WaitForChild("FishPPPart", 30)
if not fishPPPart then warn("[FATAL] FishPPPart missing after 30s") return end

print("[INIT] Waiting for shelf parent (30s)...")
local shelfParent = frameWork:WaitForChild("\232\180\167\230\158\182", 30)
if not shelfParent then warn("[FATAL] Shelf parent missing after 30s") return end

-- Get folders with long waits
local folder1 = shelfParent:WaitForChild("Folder1", 30)
local folder2 = shelfParent:WaitForChild("Folder2", 30)
local folder3 = shelfParent:WaitForChild("Folder3", 30)

print("[FOLDER STATUS] Folder1: " .. tostring(folder1))
print("[FOLDER STATUS] Folder2: " .. tostring(folder2))
print("[FOLDER STATUS] Folder3: " .. tostring(folder3))

local shelfFolders = {}
if folder1 then table.insert(shelfFolders, {obj = folder1, idx = 1, name = "Folder1"}) end
if folder2 then table.insert(shelfFolders, {obj = folder2, idx = 2, name = "Folder2"}) end
if folder3 then table.insert(shelfFolders, {obj = folder3, idx = 3, name = "Folder3"}) end

if #shelfFolders == 0 then
    warn("[FATAL] No shelf folders found - game may not have loaded them yet")
    return
end

print("[INFO] Found " .. #shelfFolders .. " shelf folders")

-- Your 17 exact shelf positions
local shelfPositions = {
    {folderIdx = 1, index = 8,   name = nil, label = "Gran Maja"},
    {folderIdx = 1, index = nil, name = "\229\177\149\229\143\176", label = "Hammerhead"},
    {folderIdx = 1, index = 14,  name = nil, label = "Sea Dweller"},
    {folderIdx = 1, index = 12,  name = nil, label = "Zombie Fish"},
    {folderIdx = 1, index = 10,  name = nil, label = "King Squid"},
    {folderIdx = 1, index = 15,  name = nil, label = "Sea Reaper"},
    {folderIdx = 1, index = 7,   name = nil, label = "BLOOP"},
    {folderIdx = 1, index = 6,   name = nil, label = "Julia Beast"},
    {folderIdx = 1, index = 5,   name = nil, label = "Ningen"},
    {folderIdx = 1, index = 3,   name = nil, label = "Plesiosaurus"},
    {folderIdx = 1, index = nil, name = "\229\177\149\229\143\1761", label = "SCP3000"},
    {folderIdx = 2, index = 6,   name = nil, label = "Megalodon"},
    {folderIdx = 2, index = nil, name = "\230\158\182\229\173\144", label = "Julia Beast"},
    {folderIdx = 3, index = 22,  name = nil, label = "Shark Girl"},
    {folderIdx = 3, index = 21,  name = nil, label = "Shark Boy"},
    {folderIdx = 3, index = 19,  name = nil, label = "Bone Shark"},
    {folderIdx = 3, index = 18,  name = nil, label = "Sea Eater"},
}

print("[INFO] Defined " .. #shelfPositions .. " target positions")

-- Get name and action text
local function getFishInfo(part)
    if not part then
        print("[SKIP] Part is nil")
        return nil, nil
    end

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt then
        print("[SKIP] No PPPart_PP in " .. part:GetFullName())
        return nil, nil
    end

    if not prompt:IsA("ProximityPrompt") then
        print("[SKIP] Not ProximityPrompt in " .. part:GetFullName())
        return nil, nil
    end

    local name = prompt.ObjectText or "Unknown Fish"
    local action = prompt.ActionText or ""

    if DEBUG then
        print("[PROMPT FOUND] " .. part:GetFullName())
        print("   ObjectText: '" .. name .. "'")
        print("   ActionText: '" .. action .. "'")
    end

    return name, action
end

-- Extract percentage
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then
        print("[PARSE] No text")
        return nil
    end

    if DEBUG then print("[PARSE] Text: " .. text:sub(1, 100)) end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v then
                if v >= THRESHOLD then
                    if DEBUG then print("[ACCEPT] " .. v .. "%") end
                    return v
                else
                    if DEBUG then print("[REJECT] " .. v .. "% < " .. THRESHOLD) end
                end
            end
        end
    end

    if DEBUG then print("[PARSE] No valid %") end
    return nil
end

-- Your webhook sender
local function SendWebhook(payload)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(payload)
    
    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if success then
        print("[WEBHOOK] Sent! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK] Failed: " .. tostring(response))
    end
end

-- Send grouped
local lastSend = 0

local function sendGrouped(detected)
    local now = tick()
    if now - lastSend < 30 then return end
    lastSend = now

    if #detected == 0 then return end

    local lines = {}
    for i, f in ipairs(detected) do
        table.insert(lines, i .. ". **" .. f.name .. "** - **" .. f.percent .. "%**")
    end

    local message = "**High % Fish Detected (" .. #detected .. " total):**\n" .. table.concat(lines, "\n")

    SendWebhook({content = message})
end

-- Scan loop
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN START] Checking your 17 shelf positions...") end

    local detected = {}

    for _, entry in ipairs(shelfPositions) do
        local shelfFolder = nil
        if entry.folderIdx == 1 then shelfFolder = folder1 end
        if entry.folderIdx == 2 then shelfFolder = folder2 end
        if entry.folderIdx == 3 then shelfFolder = folder3 end

        if not shelfFolder then
            print("[SKIP] Folder" .. entry.folderIdx .. " missing for " .. entry.label)
            continue
        end

        local part = nil
        if entry.index then
            local children = shelfFolder:GetChildren()
            if not children then
                print("[NIL] GetChildren() nil in Folder" .. entry.folderIdx)
                continue
            end
            if type(children) ~= "table" then
                print("[TYPE ERROR] GetChildren() not table in Folder" .. entry.folderIdx)
                continue
            end
            if #children < entry.index + 1 then
                print("[SKIP] Index " .. entry.index .. " out of bounds in Folder" .. entry.folderIdx .. " (only " .. #children .. ")")
                continue
            end
            part = children[entry.index + 1]
        elseif entry.name then
            part = shelfFolder:FindFirstChild(entry.name)
            if not part then
                print("[SKIP] Named part '" .. entry.name .. "' not found in Folder" .. entry.folderIdx)
            end
        end

        if not part then continue end

        local name, action = getFishInfo(part)
        if name and name ~= "" then
            local percent = extractPercentage(name, action)
            if percent then
                table.insert(detected, {name = name, percent = percent})
                if DEBUG then
                    print("[DETECT] " .. name .. " @ " .. percent .. "% - " .. entry.label)
                end
            end
        end
    end

    sendGrouped(detected)

    if DEBUG then print("[SCAN END] Found " .. #detected .. " high % fish") end
end)

print("[FishScanner] Active - only your 17 shelf positions - ≥ " .. THRESHOLD .. "%")
