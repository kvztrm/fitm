-- AutoFish Notifier - Only desired fish types + 3-stud radius check to shelf
-- Scans FishPPPart.Folder1/2/3, checks proximity to shelves in "\232\180\167\230\158\182"

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true
local SHELF_RADIUS = 3  -- studs

-- Shelf locations (hangers)
local shelfParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("\232\180\167\230\158\182", 10)

-- Fish data location
local dataParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 10)

-- Your desired fish types (case-insensitive partial match)
local wantedFishTypes = {
    "sea dweller",
    "scp3000", "scp-300", "scp 300", "scp300",
    "plesiosaurus",
    "hammerhead shark", "hammerhead",
    "bloop",
    "el gran maja", "gran maja",
    "julia beast",
    "ningen",
    "megalodon",
    "zombie fish",
    "sea eater",
    "bone shark", "boneshark",
    "shark girl",
    "shark boy",
    "king squid",
    "sea reaper"
}

local function isWantedFish(name)
    if not name then return false end
    local lower = name:lower()
    for _, w in ipairs(wantedFishTypes) do
        if lower:find(w, 1, true) then return true end
    end
    return false
end

-- Get all shelf parts (for proximity check)
local shelfParts = {}
for _, folderName in ipairs({"Folder1", "Folder2", "Folder3"}) do
    local folder = shelfParent:FindFirstChild(folderName)
    if folder then
        for _, part in ipairs(folder:GetDescendants()) do
            if part:IsA("BasePart") or part:IsA("Model") then
                table.insert(shelfParts, part)
            end
        end
    end
end

print("[FishScanner] Found " .. #shelfParts .. " shelf parts for proximity check")

-- Get prompt info
local function getPromptInfo(part)
    if not part then return nil, nil end

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil, nil end

    local name = prompt.ObjectText or "Unknown Fish"
    local action = prompt.ActionText or ""

    return name, action
end

-- Check if part is within 3 studs of any shelf
local function isNearShelf(part)
    if not part or not part:IsA("BasePart") then return false end
    local pos = part.Position

    for _, shelf in ipairs(shelfParts) do
        if shelf:IsA("BasePart") then
            if (pos - shelf.Position).Magnitude <= SHELF_RADIUS then
                return true
            end
        elseif shelf:IsA("Model") and shelf.PrimaryPart then
            if (pos - shelf.PrimaryPart.Position).Magnitude <= SHELF_RADIUS then
                return true
            end
        end
    end

    return false
end

-- Extract percentage
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end

    return nil
end

-- Webhook sender (your original)
local function SendWebhook(payload)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(payload)
    
    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if success then
        print("[WEBHOOK] Sent! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK] Failed: " .. tostring(response))
    end
end

-- Grouped webhook
local lastSend = 0

local function sendGrouped(detected)
    local now = tick()
    if now - lastSend < 30 then return end
    lastSend = now

    if #detected == 0 then return end

    local lines = {}
    for i, f in ipairs(detected) do
        table.insert(lines, i .. ". **" .. f.name .. "** - **" .. f.percent .. "%**")
    end

    local message = "**High % Fish Detected (" .. #detected .. " total):**\n" .. table.concat(lines, "\n")

    SendWebhook({content = message})
end

-- Scan loop - only scan FishPPPart folders
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN START] Scanning FishPPPart folders...") end

    local detected = {}

    for folderIdx, folder in ipairs(folders) do
        if not folder then
            if DEBUG then print("[SKIP] Folder" .. folderIdx .. " missing") end
            continue
        end

        for _, child in ipairs(folder:GetChildren()) do
            local name, action = getPromptInfo(child)
            if name and isWantedFish(name) then
                -- Check if this fish is near a shelf
                if isNearShelf(child) then
                    local percent = extractPercentage(name, action)
                    if percent then
                        table.insert(detected, {name = name, percent = percent})
                        if DEBUG then
                            print("[DETECT] " .. name .. " @ " .. percent .. "% (near shelf)")
                        end
                    end
                else
                    if DEBUG then print("[SKIP] " .. name .. " not near any shelf") end
                end
            end
        end
    end

    sendGrouped(detected)

    if DEBUG then print("[SCAN END] Found " .. #detected .. " valid fish ≥ " .. THRESHOLD .. "% on shelves") end
end)

print("[FishScanner] Active - only desired fish types near shelves - ≥ " .. THRESHOLD .. "%")
