-- AutoFish Notifier - FIXED: Names from ProximityPrompt.ObjectText (no fixed indices)
-- One combined webhook per scan cycle

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true

-- Folders
local fpp = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)

local folder1 = fpp:WaitForChild("Folder1", 5)
local folder2 = fpp:WaitForChild("Folder2", 5)
local folder3 = fpp:WaitForChild("Folder3", 5)

-- Only the positions you originally listed (we'll read real names from prompt)
local positions = {
    -- Folder1
    folder1 and folder1:GetChildren()[24],
    folder1 and folder1:GetChildren()[44],
    folder1 and folder1:GetChildren()[25],
    folder1 and folder1:GetChildren()[48],
    folder1 and folder1:GetChildren()[27],
    folder1 and folder1:GetChildren()[26],
    folder1 and folder1:GetChildren()[45],
    folder1 and folder1:GetChildren()[46],
    folder1 and folder1:GetChildren()[47],
    folder1 and folder1:GetChildren()[43],
    folder1 and folder1:GetChildren()[42],
    folder1 and folder1:GetChildren()[19],
    folder1 and folder1:GetChildren()[40],
    folder1 and folder1:GetChildren()[39],
    folder1 and folder1:GetChildren()[9],
    folder1 and folder1:GetChildren()[38],
    folder1 and folder1:GetChildren()[37],
    folder1 and folder1:GetChildren()[8],
    folder1 and folder1:GetChildren()[36],
    folder1 and folder1:GetChildren()[35],
    folder1 and folder1:GetChildren()[34],
    folder1 and folder1:GetChildren()[33],
    folder1 and folder1:GetChildren()[32],
    folder1 and folder1:GetChildren()[6],
    folder1 and folder1:GetChildren()[31],
    folder1 and folder1:GetChildren()[30],
    folder1 and folder1:GetChildren()[5],
    folder1 and folder1:GetChildren()[29],
    folder1 and folder1:GetChildren()[28],
    folder1 and folder1:GetChildren()[4],
    folder1 and folder1:GetChildren()[21],
    folder1 and folder1:GetChildren()[20],
    folder1 and folder1:GetChildren()[11],
    -- Folder2
    folder2 and folder2:GetChildren()[36],
    folder2 and folder2:GetChildren()[26],
    folder2 and folder2:GetChildren()[35],
    folder2 and folder2:GetChildren()[30],
    folder2 and folder2:GetChildren()[8],
    folder2 and folder2:GetChildren()[7],
    -- Folder3
    folder3 and folder3:GetChildren()[69],
    folder3 and folder3:GetChildren()[68],
    folder3 and folder3:GetChildren()[67],
    folder3 and folder3:GetChildren()[66],
    folder3 and folder3:GetChildren()[65],
    folder3 and folder3:GetChildren()[61],
    folder3 and folder3:GetChildren()[60],
    folder3 and folder3:GetChildren()[59],
    folder3 and folder3:GetChildren()[58],
    folder3 and folder3:GetChildren()[57],
    folder3 and folder3:GetChildren()[56],
    folder3 and folder3:GetChildren()[55],
}

print("[FishScanner] Loaded " .. #positions .. " positions to scan")

-- Get text from ProximityPrompt
local function getPromptText(fishPart)
    if not fishPart then return nil, nil end

    local prompt = fishPart:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil, nil end

    local objText = prompt.ObjectText or "Unknown"
    local actText = prompt.ActionText or ""

    return objText, actText
end

-- Extract percentage from action text or combined
local function extractPercentage(actText, objText)
    local text = (actText or "") .. " " .. (objText or "")
    if text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*)percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end

    return nil
end

-- Send one combined webhook
local function sendCombined(highFish)
    if #highFish == 0 then return end

    local lines = {}
    for _, f in ipairs(highFish) do
        table.insert(lines, "**" .. f.name .. "** - " .. f.percent .. "%")
    end

    local message = "**High % Fish Detected (" .. #highFish .. "):**\n" .. table.concat(lines, "\n")

    local payload = { content = message }

    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)

    if success then
        print("[WEBHOOK] Sent grouped message! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK FAIL] " .. tostring(response))
    end
end

-- Scan loop
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN] Starting...") end

    local highFish = {}

    for _, entry in ipairs(fishRefs) do
        local part = entry.part
        if not part then continue end

        local fishName, actionText = getPromptText(part)
        if fishName then
            local percent = extractPercentage(actionText, fishName)
            if percent then
                table.insert(highFish, {name = fishName, percent = percent})
                if DEBUG then
                    print("[DETECT] " .. fishName .. " @ " .. percent .. "% (action: " .. (actionText or "none") .. ")")
                end
            end
        end
    end

    sendCombined(highFish)

    if DEBUG then print("[SCAN END] Found " .. #highFish .. " high fish") end
end)

print("[FishScanner] Running - real names from ObjectText, grouped webhook")
