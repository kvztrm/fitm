-- AutoFish Notifier - Scan FishPPPart indices 0-150 for "Able" attribute
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"
local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true

-- Get FrameWork_WorkSpace
local workspaceFrame = workspace:WaitForChild("FrameWork_WorkSpace", 10)
if not workspaceFrame then
    error("FrameWork_WorkSpace not found!")
end

-- FishPPPart location
local fishPPPart = workspaceFrame:WaitForChild("FishPPPart", 10)
if not fishPPPart then
    error("FishPPPart folder not found!")
end

-- Get all three folders
local folders = {
    fishPPPart:WaitForChild("Folder1", 10),
    fishPPPart:WaitForChild("Folder2", 10),
    fishPPPart:WaitForChild("Folder3", 10)
}

-- Check if folders exist
for i, folder in ipairs(folders) do
    if not folder then
        error("Folder" .. i .. " not found in FishPPPart!")
    end
end

print("[FishScanner] Found all 3 FishPPPart folders")

-- Your desired fish types (case-insensitive partial match)
local wantedFishTypes = {
    "sea dweller",
    "scp3000", "scp-300", "scp 300", "scp300",
    "plesiosaurus",
    "hammerhead shark", "hammerhead",
    "bloop",
    "el gran maja", "gran maja",
    "julia beast",
    "ningen",
    "megalodon",
    "zombie fish",
    "sea eater",
    "bone shark", "boneshark",
    "shark girl",
    "shark boy",
    "king squid",
    "sea reaper"
}

-- Function to check if fish is wanted
local function isWantedFish(name)
    if not name then return false end
    local lower = name:lower()
    for _, w in ipairs(wantedFishTypes) do
        if lower:find(w:lower(), 1, true) then
            return true
        end
    end
    return false
end

-- Extract percentage from name and action text
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end
    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }
    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end
    return nil
end

-- Check if fish has "Able" attribute enabled (capital A)
local function isAbleEnabled(fishModel)
    if not fishModel then return false end
    
    -- Check for "Able" attribute (capital A)
    local ableAttr = fishModel:GetAttribute("Able")
    if ableAttr ~= nil then
        if type(ableAttr) == "boolean" then
            return ableAttr == true
        elseif type(ableAttr) == "string" then
            local val = ableAttr:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif type(ableAttr) == "number" then
            return ableAttr > 0
        end
    end
    
    -- Also check lowercase "able" just in case
    local ableAttrLower = fishModel:GetAttribute("able")
    if ableAttrLower ~= nil then
        if type(ableAttrLower) == "boolean" then
            return ableAttrLower == true
        elseif type(ableAttrLower) == "string" then
            local val = ableAttrLower:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif type(ableAttrLower) == "number" then
            return ableAttrLower > 0
        end
    end
    
    -- Check for "able" child object (backward compatibility)
    local ableChild = fishModel:FindFirstChild("able")
    if ableChild then
        if ableChild:IsA("BoolValue") then
            return ableChild.Value == true
        elseif ableChild:IsA("StringValue") then
            local val = ableChild.Value:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif ableChild:IsA("NumberValue") then
            return ableChild.Value > 0
        end
    end
    
    -- Check for "Able" child object (capital A)
    local AbleChild = fishModel:FindFirstChild("Able")
    if AbleChild then
        if AbleChild:IsA("BoolValue") then
            return AbleChild.Value == true
        elseif AbleChild:IsA("StringValue") then
            local val = AbleChild.Value:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif AbleChild:IsA("NumberValue") then
            return AbleChild.Value > 0
        end
    end
    
    return false
end

-- Get fish info from model
local function getFishInfo(fishModel)
    if not fishModel then return nil, nil, nil end
    
    -- Get prompt info
    local prompt = fishModel:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then
        return nil, nil, nil
    end
    
    local name = prompt.ObjectText or fishModel.Name
    local action = prompt.ActionText or ""
    
    -- Check if Able attribute is enabled
    local enabled = isAbleEnabled(fishModel)
    
    return name, action, enabled
end

-- Webhook sender
local function SendWebhook(fishName, percent)
    local headers = {["Content-Type"] = "application/json"}
    local message = "**" .. fishName .. "** - **" .. percent .. "%** (Able: true)"
    local payload = {content = message}
    local body = HttpService:JSONEncode(payload)
    
    if DEBUG then print("[WEBHOOK] Sending: " .. message) end
    
    local success, response = pcall(function()
        return HttpService:PostAsync(WEBHOOK_URL, body, Enum.HttpContentType.ApplicationJson)
    end)
    
    if success then
        print("[WEBHOOK] ✓ Sent: " .. fishName .. " @ " .. percent .. "%")
    else
        warn("[WEBHOOK] ✗ Failed: " .. tostring(response))
        
        -- Try request if available
        if request then
            local success2 = pcall(function()
                request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = headers,
                    Body = body
                })
            end)
            if success2 then
                print("[WEBHOOK] ✓ Sent via request")
            end
        end
    end
end

-- Track sent fish to avoid duplicates
local sentFish = {}
local COOLDOWN = 300 -- 5 minutes cooldown

-- Main scan function
local function scanFishPPPart()
    if DEBUG then print("\n" .. string.rep("=", 60)) end
    if DEBUG then print("[SCAN START] Scanning FishPPPart indices 0-150 for Able=true...") end
    
    local totalScanned = 0
    local enabledCount = 0
    local wantedCount = 0
    local sentCount = 0
    
    for folderIndex, folder in ipairs(folders) do
        if DEBUG then print("\n[SCAN] Folder" .. folderIndex .. " (" .. folder.Name .. ")") end
        
        -- Scan indices 0 to 150
        for i = 0, 150 do
            totalScanned = totalScanned + 1
            
            -- Get child at index i
            local children = folder:GetChildren()
            if i + 1 <= #children then
                local fishModel = children[i + 1]
                
                -- Get fish info
                local name, action, enabled = getFishInfo(fishModel)
                
                if name and enabled then
                    enabledCount = enabledCount + 1
                    
                    if DEBUG then
                        print("[ABLE] " .. name .. " has Able=true (Index " .. i .. ")")
                    end
                    
                    -- Check if it's a wanted fish
                    if isWantedFish(name) then
                        wantedCount = wantedCount + 1
                        
                        -- Extract percentage
                        local percent = extractPercentage(name, action)
                        if percent then
                            -- Check cooldown
                            local now = tick()
                            local lastSent = sentFish[name] or 0
                            
                            if now - lastSent >= COOLDOWN then
                                if DEBUG then
                                    print("[FOUND] ✓ " .. name .. " @ " .. percent .. "% (Index " .. i .. " in " .. folder.Name .. ")")
                                end
                                
                                -- Send webhook
                                SendWebhook(name, percent)
                                sentFish[name] = now
                                sentCount = sentCount + 1
                            else
                                if DEBUG then
                                    local remaining = COOLDOWN - (now - lastSent)
                                    print("[COOLDOWN] " .. name .. " @ " .. percent .. "% (" .. math.floor(remaining) .. "s cooldown)")
                                end
                            end
                        elseif DEBUG then
                            print("[NO-PERCENT] " .. name .. " (no valid percentage)")
                        end
                    elseif DEBUG then
                        print("[NOT-WANTED] " .. name .. " (Able enabled but not wanted)")
                    end
                elseif DEBUG and i % 30 == 0 then
                    -- Print progress every 30 indices
                    print("[PROGRESS] Folder" .. folderIndex .. ": Scanned " .. i .. "/150 indices")
                end
            else
                -- No child at this index
                if DEBUG and i == 0 then
                    print("[INFO] Folder" .. folderIndex .. " has " .. #children .. " children total")
                end
            end
        end
    end
    
    if DEBUG then
        print("\n[SCAN END] Summary:")
        print("  Total indices checked: " .. totalScanned)
        print("  Models with Able=true: " .. enabledCount)
        print("  Wanted fish with Able=true: " .. wantedCount)
        print("  Webhooks sent: " .. sentCount)
        print(string.rep("=", 60))
    end
end

-- Start scanning
local lastScan = 0
RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now
    
    scanFishPPPart()
end)

-- Initial info
print("\n[FishScanner] Active!")
print("  • Scanning: FishPPPart.Folder1/2/3")
print("  • Indices: 0 to 150 in each folder")
print("  • Checking: Attribute 'Able' = true")
print("  • Threshold: ≥ " .. THRESHOLD .. "%")
print("  • Scan interval: " .. SCAN_INTERVAL .. " seconds")
print("  • Cooldown: " .. COOLDOWN .. " seconds per fish")
print("  • Wanted fish types: " .. #wantedFishTypes)

-- Test the Able attribute check
if DEBUG then
    print("\n[TEST] Testing Able attribute detection...")
    -- Test a few models to see their Able attribute
    for _, folder in ipairs(folders) do
        local children = folder:GetChildren()
        if #children > 0 then
            local testModel = children[1]
            local ableValue = testModel:GetAttribute("Able")
            print("[TEST] " .. testModel.Name .. ": Able = " .. tostring(ableValue))
            break
        end
    end
end

-- Send startup notification
wait(2)
local startupMsg = "**[STARTUP]** FishScanner active! Scanning FishPPPart for fish with Able=true."
local payload = {content = startupMsg}
local body = HttpService:JSONEncode(payload)

pcall(function()
    HttpService:PostAsync(WEBHOOK_URL, body, Enum.HttpContentType.ApplicationJson)
    print("[WEBHOOK] Startup message sent")
end)

-- Initial scan
wait(5)
scanFishPPPart()
