-- AutoFish: Discord Webhook Notifier (Inspired by Roblox webhook tutorials)
-- Embed style with title, fields, color, timestamp | Threshold 50% for testing | Proxy used

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Proxied webhook URL (required for live games - direct discord.com blocked)
local WEBHOOK_URL = "https://webhook.lewisakura.moe/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50   -- For testing; change to 200+ later
local DEBUG = true     -- Set to false when done testing

-- Embed style config (inspired by clean notifier embeds)
local EMBED_TITLE = "ðŸš¨ High Value Fish Spawn Alert!"
local EMBED_COLOR = 0xFF5555  -- Bright red/orange for attention
local FOOTER_TEXT = "AutoFish Scanner â€¢ " .. game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name

-- References to your PPPart_PP
local folder1 = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)
    :WaitForChild("Folder1", 5)

local displayObj = folder1:GetChildren()[14]
local ppPart = displayObj and displayObj:FindFirstChild("PPPart_PP")

if not ppPart then
    warn("[FishNotifier] PPPart_PP not found at Folder1:GetChildren()[14]")
    return
end

print("[FishNotifier] Monitoring started on " .. ppPart:GetFullName() .. " | Threshold: " .. THRESHOLD .. "%")

local lastText = ""
local lastValue = 0

local function extractPercentageAndFish(rawText)
    if typeof(rawText) ~= "string" or rawText == "" then
        if DEBUG then print("[DEBUG] Empty or invalid ObjectText") end
        return nil, nil
    end

    if rawText == lastText then return lastValue, nil end

    if DEBUG then print("[DEBUG] New text: \"" .. rawText .. "\"") end

    lastText = rawText
    local text = rawText:lower():gsub(" ", "")

    -- Percentage patterns
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+%.?%d*) ?percent",
        "(%d+)%%?",
        "over (%d+)"
    }

    local value
    for _, pat in ipairs(patterns) do
        local numStr = text:match(pat)
        if numStr then
            value = tonumber(numStr)
            if value then break end
        end
    end

    if not value or value < THRESHOLD then return nil, nil end
    if value == lastValue then return nil, nil end

    -- Fish name extraction (adjust patterns if your text format is known)
    local fishName = text:match("([%w%s]+)%d+%%") 
                  or text:match("([%w%s]+)at%d+%%") 
                  or text:match("([%w%s]+)%d+%%") 
                  or rawText:match("([%w%s]+)%d+")  
                  or "Mystery Fish"

    fishName = fishName:gsub("^%s*(.-)%s*$", "%1"):gsub("%s+", " ")

    if DEBUG then print("[DEBUG] Parsed: " .. fishName .. " @ " .. value .. "%") end

    lastValue = value
    return value, fishName
end

local function sendWebhook(value, fishName)
    fishName = fishName or "Unknown Fish"
    value = value or 0

    local description = "A high-percentage fish has spawned! Get in-game fast!"

    if DEBUG then print("[DEBUG] Building embed for " .. fishName .. " (" .. value .. "%)") end

    local data = {
        embeds = {{
            title = EMBED_TITLE,
            description = description,
            color = EMBED_COLOR,
            fields = {
                {
                    name = "Fish",
                    value = "**" .. fishName .. "**",
                    inline = true
                },
                {
                    name = "Percentage",
                    value = "**" .. tostring(value) .. "%**",
                    inline = true
                }
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
            footer = {
                text = FOOTER_TEXT
            }
        }}
    }

    local json = HttpService:JSONEncode(data)

    local success, err = pcall(function()
        HttpService:PostAsync(WEBHOOK_URL, json, Enum.HttpContentType.ApplicationJson)
    end)

    if success then
        print("[FishNotifier] SUCCESS: Sent notification â†’ " .. fishName .. " (" .. value .. "%)")
    else
        warn("[FishNotifier] Webhook failed: " .. tostring(err))
    end
end

-- Main background loop
RunService.Heartbeat:Connect(function()
    local text = ppPart.ObjectText
        or (ppPart:FindFirstChildWhichIsA("TextLabel") and ppPart:FindFirstChildWhichIsA("TextLabel").ObjectText)
        or (ppPart:FindFirstChild("SurfaceGui") and ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel") and ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel").ObjectText)

    if not text or text == "" then return end

    local value, fishName = extractPercentageAndFish(text)
    if value then
        sendWebhook(value, fishName)
    end
end)
