-- AutoFish Notifier - Scans exact shelf positions in special folder
-- Gets name & % from corresponding PPPart_PP in FishPPPart folders
-- Groups high % fish into one webhook

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local SCAN_INTERVAL = 90   -- seconds
local DEBUG = true

-- Shelf locations (hangers)
local shelfParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("\232\180\167\230\158\182", 5)

local shelfFolders = {
    shelfParent:WaitForChild("Folder1", 5),
    shelfParent:WaitForChild("Folder2", 5),
    shelfParent:WaitForChild("Folder3", 5)
}

-- Fish data locations (PPPart_PP prompts)
local fishDataParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)

local fishDataFolders = {
    fishDataParent:WaitForChild("Folder1", 5),
    fishDataParent:WaitForChild("Folder2", 5),
    fishDataParent:WaitForChild("Folder3", 5)
}

-- Your exact shelf positions (index in shelf folder -> label)
local shelfPositions = {
    {index = 8,   folderIdx = 1, label = "Gran Maja"},
    {index = nil, name = "\229\177\149\229\143\176", folderIdx = 1, label = "Hammerhead"},
    {index = 14,  folderIdx = 1, label = "Sea Dweller"},
    {index = 12,  folderIdx = 1, label = "Zombie Fish"},
    {index = 10,  folderIdx = 1, label = "King Squid"},
    {index = 15,  folderIdx = 1, label = "Sea Reaper"},
    {index = 7,   folderIdx = 1, label = "BLOOP"},
    {index = 6,   folderIdx = 1, label = "Julia Beast"},
    {index = 5,   folderIdx = 1, label = "Ningen"},
    {index = 3,   folderIdx = 1, label = "Plesiosaurus"},
    {index = nil, name = "\229\177\149\229\143\1761", folderIdx = 1, label = "SCP3000"},
    {index = 6,   folderIdx = 2, label = "Megalodon"},
    {index = nil, name = "\230\158\182\229\173\144", folderIdx = 2, label = "Julia Beast"},
    {index = 22,  folderIdx = 3, label = "Shark Girl"},
    {index = 21,  folderIdx = 3, label = "Shark Boy"},
    {index = 19,  folderIdx = 3, label = "Bone Shark"},
    {index = 18,  folderIdx = 3, label = "Sea Eater"},
}

print("[FishScanner] Loaded " .. #shelfPositions .. " exact shelf positions")

-- Get name and action text from corresponding PPPart_PP in fish data folder
local function getFishInfo(shelfPart, fishDataFolder)
    if not shelfPart or not fishDataFolder then return nil, nil end

    -- Find matching PPPart_PP in fish data folder (same index or name)
    local prompt = nil
    if shelfPart.Name then
        prompt = fishDataFolder:FindFirstChild(shelfPart.Name, true)
    end

    if not prompt then
        -- fallback to same index if name not found
        local idx = table.find(shelfPositions, function(e) return e.part == shelfPart end)
        if idx then
            local child = fishDataFolder:GetChildren()[idx]
            if child then
                prompt = child:FindFirstChild("PPPart_PP")
            end
        end
    end

    if not prompt or not prompt:IsA("ProximityPrompt") then return nil, nil end

    local name = prompt.ObjectText or "Unknown Fish"
    local action = prompt.ActionText or ""

    return name, action
end

-- Extract percentage
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end

    return nil
end

-- Your exact webhook sender
local function SendWebhook(payload)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(payload)
    
    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if success then
        print("[WEBHOOK] Sent! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK] Failed: " .. tostring(response))
    end
end

-- Send grouped webhook
local lastSend = 0

local function sendGrouped(detected)
    local now = tick()
    if now - lastSend < 30 then return end
    lastSend = now

    if #detected == 0 then return end

    local lines = {}
    for i, f in ipairs(detected) do
        table.insert(lines, i .. ". **" .. f.name .. "** - **" .. f.percent .. "%**")
    end

    local message = "**High % Fish on Shelves (" .. #detected .. " total):**\n" .. table.concat(lines, "\n")

    SendWebhook({content = message})
end

-- Scan loop
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN START] Checking your 17 shelf positions...") end

    local detected = {}

    for _, entry in ipairs(shelfFish) do
        local shelfPart = entry.part
        if not shelfPart then continue end

        -- Find corresponding data in FishPPPart (same folder index)
        local dataFolder = fishDataFolders[entry.folderIdx]
        if not dataFolder then continue end

        local name, action = getFishInfo(shelfPart, dataFolder)
        if name and name ~= "" then
            local percent = extractPercentage(name, action)
            if percent then
                table.insert(detected, {name = name, percent = percent})
                if DEBUG then
                    print("[DETECT] " .. name .. " @ " .. percent .. "%")
                end
            end
        end
    end

    sendGrouped(detected)

    if DEBUG then print("[SCAN END] Found " .. #detected .. " high % fish on shelves") end
end)

print("[FishScanner] Active - only your 17 shelf positions - threshold â‰¥ " .. THRESHOLD .. "%")
