-- AutoFish Notifier - Shelves in chinese folder, prompts in FishPPPart
-- Only reports fish present on shelves + ≥50%

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true

-- Shelf locations (hangers)
local shelfParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("\232\180\167\230\158\182", 10)

-- Data locations (prompts)
local dataParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 10)

-- Your 17 exact positions (shelf index/name → label)
local positions = {
    {folder = 1, index = 8,   name = nil, label = "Gran Maja"},
    {folder = 1, index = nil, name = "\229\177\149\229\143\176", label = "Hammerhead"},
    {folder = 1, index = 14,  name = nil, label = "Sea Dweller"},
    {folder = 1, index = 12,  name = nil, label = "Zombie Fish"},
    {folder = 1, index = 10,  name = nil, label = "King Squid"},
    {folder = 1, index = 15,  name = nil, label = "Sea Reaper"},
    {folder = 1, index = 7,   name = nil, label = "BLOOP"},
    {folder = 1, index = 6,   name = nil, label = "Julia Beast"},
    {folder = 1, index = 5,   name = nil, label = "Ningen"},
    {folder = 1, index = 3,   name = nil, label = "Plesiosaurus"},
    {folder = 1, index = nil, name = "\229\177\149\229\143\1761", label = "SCP3000"},
    {folder = 2, index = 6,   name = nil, label = "Megalodon"},
    {folder = 2, index = nil, name = "\230\158\182\229\173\144", label = "Julia Beast"},
    {folder = 3, index = 22,  name = nil, label = "Shark Girl"},
    {folder = 3, index = 21,  name = nil, label = "Shark Boy"},
    {folder = 3, index = 19,  name = nil, label = "Bone Shark"},
    {folder = 3, index = 18,  name = nil, label = "Sea Eater"},
}

print("[INIT] Loaded " .. #positions .. " positions")

-- Get prompt from data folder (match by index or name)
local function getPromptFromData(folderIdx, entry)
    local dataFolder = dataParent:FindFirstChild("Folder" .. folderIdx)
    if not dataFolder then
        print("[SKIP] Data Folder" .. folderIdx .. " missing")
        return nil
    end

    local child = nil
    if entry.index then
        local children = dataFolder:GetChildren()
        if children and #children >= entry.index + 1 then
            child = children[entry.index + 1]
        end
    elseif entry.name then
        child = dataFolder:FindFirstChild(entry.name)
    end

    if not child then return nil end

    local prompt = child:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil end

    return prompt
end

-- Scan
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN START] Checking 17 positions...") end

    local detected = {}

    for _, entry in ipairs(positions) do
        -- Check if fish is on shelf (existence check)
        local shelfFolder = shelfParent:FindFirstChild("Folder" .. entry.folderIdx)
        if not shelfFolder then
            if DEBUG then print("[SKIP] Shelf Folder" .. entry.folderIdx .. " missing") end
            continue
        end

        local shelfPart = nil
        if entry.index then
            local children = shelfFolder:GetChildren()
            if children and #children >= entry.index + 1 then
                shelfPart = children[entry.index + 1]
            end
        elseif entry.name then
            shelfPart = shelfFolder:FindFirstChild(entry.name)
        end

        if not shelfPart then
            if DEBUG then print("[SKIP] " .. entry.label .. " not on shelf") end
            continue
        end

        -- Fish is on shelf → get data from FishPPPart
        local prompt = getPromptFromData(entry.folderIdx, entry)
        if not prompt then
            if DEBUG then print("[SKIP] No prompt for " .. entry.label) end
            continue
        end

        local name = prompt.ObjectText or entry.label
        local action = prompt.ActionText or ""

        local percent = nil
        local text = name .. " " .. action
        local clean = text:lower():gsub("%s+", "")

        local patterns = {"(%d+%.?%d*)%%", "(%d+)%%", "(%d+%.?%d*) ?percent", "%%(%d+)"}
        for _, pat in ipairs(patterns) do
            local numStr = clean:match(pat)
            if numStr then
                local v = tonumber(numStr)
                if v and v >= THRESHOLD then
                    percent = v
                    break
                end
            end
        end

        if percent then
            table.insert(detected, {name = name, percent = percent})
            if DEBUG then
                print("[DETECT] " .. name .. " @ " .. percent .. "% - " .. entry.label)
            end
        end
    end

    if #detected > 0 then
        local lines = {}
        for i, f in ipairs(detected) do
            table.insert(lines, i .. ". **" .. f.name .. "** - **" .. f.percent .. "%**")
        end

        local message = "**High % Fish on Shelves (" .. #detected .. " total):**\n" .. table.concat(lines, "\n")

        local payload = {content = message}
        SendWebhook(payload)
    else
        if DEBUG then print("[SCAN] No high % fish on shelves") end
    end
end)

print("[FishScanner] Active - only your 17 positions - ≥ " .. THRESHOLD .. "%")
