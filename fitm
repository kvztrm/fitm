-- AutoFish Notifier - Full index scan (0-150) in Folder1/2/3
-- Extracts real name + percentage, sends one grouped webhook (split if too long)

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local MAX_INDEX = 150
local SCAN_INTERVAL = 90   -- seconds
local DEBUG = true

-- Folders
local fpp = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)

local folder1 = fpp:WaitForChild("Folder1", 5)
local folder2 = fpp:WaitForChild("Folder2", 5)
local folder3 = fpp:WaitForChild("Folder3", 5)

local folders = {folder1, folder2, folder3}

print("[FishScanner] Starting - full scan 0–" .. MAX_INDEX .. " in Folder1/2/3")

-- Your exact webhook sender function
local function SendWebhook(payload)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(payload)
    
    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if success then
        print("[WEBHOOK] Sent! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK] Failed: " .. tostring(response))
    end
end

-- Get name and action text from prompt
local function getFishInfo(part)
    if not part then return nil, nil end

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil, nil end

    local name = prompt.ObjectText or "Unknown Fish"
    local action = prompt.ActionText or ""

    return name, action
end

-- Extract percentage
local function getPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end

    return nil
end

-- Send grouped webhook (with splitting if too long)
local lastSend = 0

local function sendGrouped(detected)
    local now = tick()
    if now - lastSend < 30 then return end
    lastSend = now

    if #detected == 0 then return end

    -- Sort by highest % (optional)
    table.sort(detected, function(a, b) return a.percent > b.percent end)

    local chunkSize = 20  -- safe number to stay under 2000 chars
    local chunks = {}

    for i = 1, #detected, chunkSize do
        local chunk = {}
        for j = i, math.min(i + chunkSize - 1, #detected) do
            table.insert(chunk, detected[j])
        end
        table.insert(chunks, chunk)
    end

    for chunkIdx, chunk in ipairs(chunks) do
        local lines = {}
        for i, f in ipairs(chunk) do
            table.insert(lines, i .. ". **" .. f.name .. "** - **" .. f.percent .. "%**")
        end

        local header = "**Fish ≥ " .. THRESHOLD .. "% (" .. #detected .. " total"
        if #chunks > 1 then
            header = header .. " - Part " .. chunkIdx .. "/" .. #chunks
        end
        header = header .. "):**\n"

        local message = header .. table.concat(lines, "\n")

        -- Send this chunk
        SendWebhook({content = message})

        -- Small delay between messages
        task.wait(1.5)
    end
end

-- Scan loop - checks 0 to 150 in each folder
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN START] Checking 0–" .. MAX_INDEX .. "...") end

    local detected = {}

    for fIdx, folder in ipairs(folders) do
        if not folder then continue end

        for i = 0, MAX_INDEX do
            local child = folder:GetChildren()[i + 1]
            if not child then continue end

            local name, action = getFishInfo(child)
            if name then
                local percent = getPercentage(name, action)
                if percent then
                    table.insert(detected, {name = name, percent = percent})
                    if DEBUG then
                        print("[DETECT] " .. name .. " @ " .. percent .. "% (Folder " .. fIdx .. ", idx " .. i .. ")")
                    end
                end
            end
        end
    end

    sendGrouped(detected)

    if DEBUG then print("[SCAN END] Detected " .. #detected .. " fish ≥ " .. THRESHOLD .. "%") end
end)

print("[FishScanner] Running - full index scan - ≥ " .. THRESHOLD .. "%")
