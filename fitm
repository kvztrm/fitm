-- AutoFish: Background Scanner â†’ Discord Webhook via Proxy
-- .ObjectText | Threshold 50% for testing | Nil crash fixed

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Proxied URL (this works in live games; direct discord.com does NOT)
local WEBHOOK_URL = "https://webhook.lewisakura.moe/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local DEBUG = true

-- References
local folder1 = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)
    :WaitForChild("Folder1", 5)

local displayObj = folder1:GetChildren()[14]
local ppPart = displayObj and displayObj:FindFirstChild("PPPart_PP")

if not ppPart then
    warn("[FishWebhook] PPPart_PP not found!")
    return
end

print("[FishWebhook] Monitoring: " .. ppPart:GetFullName() .. " | Using proxy")

local lastText = ""
local lastValue = 0

local function extractPercentageAndFish(rawText)
    if typeof(rawText) ~= "string" or rawText == "" then return nil, nil end
    if rawText == lastText then return lastValue, nil end

    if DEBUG then print("[DEBUG] Raw text: \"" .. rawText .. "\"") end

    lastText = rawText
    local text = rawText:lower():gsub(" ", "")

    local value
    for _, pat in ipairs({
        "(%d+%.?%d*)%%",
        "(%d+%.?%d*) ?percent",
        "(%d+)%%?",
        "over (%d+)"
    }) do
        local numStr = text:match(pat)
        if numStr then
            value = tonumber(numStr)
            if value then break end
        end
    end

    if not value or value < THRESHOLD then return nil, nil end
    if value == lastValue then return nil, nil end

    local fishName = text:match("([%w%s]+)%d+%%") 
                  or text:match("([%w%s]+)at%d+%%") 
                  or text:match("([%w%s]+)%d+%%") 
                  or rawText:match("([%w%s]+)%d+")  
                  or "Unknown Fish"

    fishName = fishName:gsub("^%s*(.-)%s*$", "%1"):gsub("%s+", " ")
    if fishName == "" then fishName = "Unknown Fish" end

    lastValue = value
    return value, fishName
end

local function sendWebhook(value, fishName)
    fishName = fishName or "Unknown Fish"
    value = value or 0

    local description = fishName .. " detected at **" .. tostring(value) .. "%**!"

    if DEBUG then print("[DEBUG] Sending: " .. description) end

    local data = {
        embeds = {{
            title = "Fish Spawn Detected (TEST)",
            description = description,
            color = 0x55AA55,
            fields = {
                {name = "Percentage", value = tostring(value) .. "%", inline = true},
                {name = "Fish", value = fishName, inline = true}
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }}
    }

    local success, err = pcall(function()
        HttpService:PostAsync(WEBHOOK_URL, HttpService:JSONEncode(data), Enum.HttpContentType.ApplicationJson)
    end)

    if success then
        print("[SUCCESS] Sent: " .. fishName .. " (" .. value .. "%)")
    else
        warn("[ERROR] Failed: " .. tostring(err))
    end
end

RunService.Heartbeat:Connect(function()
    local text = ppPart.ObjectText
        or (ppPart:FindFirstChildWhichIsA("TextLabel") and ppPart:FindFirstChildWhichIsA("TextLabel").ObjectText)
        or (ppPart:FindFirstChild("SurfaceGui") and ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel") and ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel").ObjectText)

    if not text or text == "" then return end

    local value, fishName = extractPercentageAndFish(text)
    if value then
        sendWebhook(value, fishName)
    end
end)

print("[FishWebhook] Active - threshold " .. THRESHOLD .. "%")
