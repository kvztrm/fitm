-- AutoFish Notifier - Scans indices 0 to 150 in Folder1/2/3
-- Only reports ≥ 50% - grouped webhook

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50       -- changed to ≥ 50%
local MAX_INDEX = 150
local SCAN_INTERVAL = 90   -- seconds
local DEBUG = true

-- Folders
local fpp = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)

local folder1 = fpp:WaitForChild("Folder1", 5)
local folder2 = fpp:WaitForChild("Folder2", 5)
local folder3 = fpp:WaitForChild("Folder3", 5)

local folders = {folder1, folder2, folder3}

print("[FishScanner] Ready - checking indices 0–" .. MAX_INDEX .. " in each folder every " .. SCAN_INTERVAL .. "s")

-- Get text from PPPart_PP
local function readPrompt(part)
    if not part then return nil end

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil end

    return (prompt.ObjectText or "") .. " " .. (prompt.ActionText or "")
end

-- Extract first valid number ≥ threshold
local function getNumber(text)
    if not text or text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)",
        "(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local match = clean:match(pat)
        if match then
            local num = tonumber(match)
            if num and num >= THRESHOLD then
                return num
            end
        end
    end

    return nil
end

-- Your exact webhook sender function
local function SendWebhook(payload)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(payload)
    
    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if success then
        print("[WEBHOOK] Sent! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK] Failed: " .. tostring(response))
    end
end

-- Send grouped webhook
local lastSend = 0

local function sendGrouped(detected)
    local now = tick()
    if now - lastSend < 30 then return end
    lastSend = now
    
    if #detected == 0 then return end
    
    local lines = {}
    for i, entry in ipairs(detected) do
        table.insert(lines, i .. ". **" .. entry.name .. "** - **" .. entry.value .. "**")
    end
    
    local message = "**Detected ≥" .. THRESHOLD .. "% (" .. #detected .. " total):**\n" .. table.concat(lines, "\n")
    
    SendWebhook({content = message})
end

-- Main scan
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now
    
    if DEBUG then print("[SCAN START] Indices 0–" .. MAX_INDEX .. " across folders") end
    
    local detected = {}
    
    for fIdx, folder in ipairs(folders) do
        if not folder then continue end
        
        for i = 0, MAX_INDEX do
            local child = folder:GetChildren()[i + 1]  -- Lua 1-based
            if not child then continue end
            
            local text = readPrompt(child)
            if text then
                local value = getNumber(text)
                if value then
                    local entryName = child.Name or ("Idx " .. i .. " (F" .. fIdx .. ")")
                    table.insert(detected, {name = entryName, value = value})
                    
                    if DEBUG then
                        print(string.format("[FOUND] F%d idx %d → %s = %d", fIdx, i, entryName, value))
                    end
                end
            end
        end
    end
    
    sendGrouped(detected)
    
    if DEBUG then print("[SCAN END] Detected " .. #detected .. " items ≥ " .. THRESHOLD .. "%") end
end)

print("[FishScanner] Running - threshold ≥ " .. THRESHOLD .. "% - indices 0–" .. MAX_INDEX)
