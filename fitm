-- AutoFish Notifier - ONLY your listed fish types on shelves
-- Scans shelf positions in "\232\180\167\230\158\182".Folder1/2/3
-- Groups name + percentage ≥50% into one webhook

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50
local SCAN_INTERVAL = 90   -- seconds
local DEBUG = true

-- Shelf locations (hangers)
local shelfParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("\232\180\167\230\158\182", 5)

local shelfFolders = {
    shelfParent:WaitForChild("Folder1", 5),
    shelfParent:WaitForChild("Folder2", 5),
    shelfParent:WaitForChild("Folder3", 5)
}

-- Fish data locations (prompts)
local fishDataParent = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)

local fishDataFolders = {
    fishDataParent:WaitForChild("Folder1", 5),
    fishDataParent:WaitForChild("Folder2", 5),
    fishDataParent:WaitForChild("Folder3", 5)
}

-- Your exact wanted fish names (case-insensitive partial match)
local wantedFish = {
    "sea dweller",
    "scp3000", "scp-300", "scp 300", "scp300",
    "plesiosaurus",
    "hammerhead shark", "hammerhead",
    "bloop",
    "el gran maja", "gran maja",
    "julia beast",
    "ningen",
    "megalodon",
    "zombie fish",
    "sea eater",
    "bone shark", "boneshark",
    "shark girl",
    "shark boy",
    "king squid",
    "sea reaper"
}

-- Check if name matches any wanted fish
local function isWantedFish(name)
    if not name then return false end
    local lower = name:lower()
    for _, w in ipairs(wantedFish) do
        if lower:find(w, 1, true) then
            return true
        end
    end
    return false
end

-- Get name and action text from prompt
local function getFishInfo(part)
    if not part then return nil, nil end

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then return nil, nil end

    local name = prompt.ObjectText or "Unknown Fish"
    local action = prompt.ActionText or ""

    return name, action
end

-- Extract percentage
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end

    return nil
end

-- Your exact webhook sender
local function SendWebhook(payload)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(payload)
    
    local success, response = pcall(function()
        return request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if success then
        print("[WEBHOOK] Sent! Status: " .. (response.StatusCode or "no code"))
    else
        warn("[WEBHOOK] Failed: " .. tostring(response))
    end
end

-- Send grouped webhook
local lastSend = 0

local function sendGrouped(detected)
    local now = tick()
    if now - lastSend < 30 then return end
    lastSend = now

    if #detected == 0 then return end

    local lines = {}
    for i, f in ipairs(detected) do
        table.insert(lines, i .. ". **" .. f.name .. "** - **" .. f.percent .. "%**")
    end

    local message = "**High % Fish on Shelves (" .. #detected .. " total):**\n" .. table.concat(lines, "\n")

    SendWebhook({content = message})
end

-- Scan loop - only your listed fish on shelves
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    if DEBUG then print("[SCAN START] Checking your 17 shelf positions...") end

    local detected = {}

    for _, entry in ipairs(shelfPositions) do
        local folder = shelfFolders[entry.folderIdx]
        if not folder then continue end

        local part = nil
        if entry.index then
            part = folder:GetChildren()[entry.index + 1]  -- Lua 1-based
        elseif entry.name then
            part = folder:FindFirstChild(entry.name)
        end

        if not part then
            if DEBUG then print("[SKIP] Missing position: " .. entry.label) end
            continue
        end

        -- Get name and % from the corresponding prompt in FishPPPart
        local dataFolder = fishDataFolders[entry.folderIdx]
        if not dataFolder then continue end

        local name, action = getFishInfo(part)
        if name and isWantedFish(name) then
            local percent = extractPercentage(name, action)
            if percent then
                table.insert(detected, {name = name, percent = percent})
                if DEBUG then
                    print("[DETECT] " .. name .. " @ " .. percent .. "% - " .. entry.label)
                end
            end
        end
    end

    sendGrouped(detected)

    if DEBUG then print("[SCAN END] Found " .. #detected .. " high % fish on shelves") end
end)

print("[FishScanner] Active - only your 17 fish types on shelves - ≥ " .. THRESHOLD .. "%")
