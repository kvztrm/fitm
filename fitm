-- AutoFish: Discord Webhook Notifier (Rewritten + Improved)
-- Detects high % in PPPart_PP.ObjectText â†’ sends nice embed to Discord via proxy
-- Debug prints help find why it's not sending

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Proxy webhook URL (required - direct discord.com blocked in live games)
local WEBHOOK_URL = "https://webhook.lewisakura.moe/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"

local THRESHOLD = 50          -- Change to 200+ when ready
local DEBUG = true            -- Set false later to quiet console
local COOLDOWN = 5            -- seconds between sends (prevent spam)

-- Embed style
local EMBED_TITLE = "ðŸš¨ HIGH VALUE FISH SPAWNED!"
local EMBED_COLOR = 0xFF4444  -- Bright red alert
local FOOTER = "AutoFish Scanner â€¢ " .. game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name

-- Get the part
local folder1 = workspace:WaitForChild("FrameWork_WorkSpace", 10)
    :WaitForChild("FishPPPart", 5)
    :WaitForChild("Folder1", 5)

local displayObj = folder1:GetChildren()[14]
local ppPart = displayObj and displayObj:FindFirstChild("PPPart_PP")

if not ppPart then
    warn("[FishNotifier] ERROR: PPPart_PP not found!")
    return
end

print("[FishNotifier] Started monitoring: " .. ppPart:GetFullName() .. " | Threshold â‰¥ " .. THRESHOLD .. "%")

local lastText = ""
local lastValue = 0
local lastSendTime = 0

local function getText()
    return ppPart.ObjectText
        or (ppPart.Text)  -- fallback if it's a Text property
        or (ppPart:FindFirstChildWhichIsA("TextLabel") and (ppPart:FindFirstChildWhichIsA("TextLabel").ObjectText or ppPart:FindFirstChildWhichIsA("TextLabel").Text))
        or (ppPart:FindFirstChild("SurfaceGui") and ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel") and (ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel").ObjectText or ppPart.SurfaceGui:FindFirstChildWhichIsA("TextLabel").Text))
end

local function extractPercentageAndFish(rawText)
    if typeof(rawText) ~= "string" or rawText == "" then
        return nil, nil
    end

    if rawText == lastText then
        return lastValue, nil
    end

    if DEBUG then
        print("[DEBUG] Detected new text: \"" .. rawText .. "\"")
    end

    lastText = rawText
    local lower = rawText:lower():gsub(" ", "")

    local value
    local patterns = {"(%d+%.?%d*)%%", "(%d+%.?%d*) ?percent", "(%d+)%%?", "over (%d+)"}
    for _, pat in ipairs(patterns) do
        local match = lower:match(pat)
        if match then
            value = tonumber(match)
            if value then break end
        end
    end

    if not value or value < THRESHOLD then
        if DEBUG then print("[DEBUG] Skip: value = " .. (value or "none") .. " < " .. THRESHOLD) end
        return nil, nil
    end

    if value == lastValue then
        if DEBUG then print("[DEBUG] Skip: same value as before (" .. value .. "%)") end
        return nil, nil
    end

    local fishName = lower:match("([%w%s]+)%d+%%")
        or lower:match("([%w%s]+)at%d+%%")
        or lower:match("([%w%s]+)%d+%%")
        or rawText:match("([%w%s]+)%d+")
        or "Unknown Fish"

    fishName = fishName:gsub("^%s*(.-)%s*$", "%1"):gsub("%s+", " ")

    if DEBUG then
        print("[DEBUG] Parsed â†’ Fish: " .. fishName .. " | Value: " .. value .. "%")
    end

    lastValue = value
    return value, fishName
end

local function sendWebhook(value, fishName)
    fishName = fishName or "Unknown Fish"

    local now = os.time()
    if now - lastSendTime < COOLDOWN then
        if DEBUG then print("[DEBUG] Cooldown active - skip send") end
        return
    end

    lastSendTime = now

    local data = {
        embeds = {{
            title = EMBED_TITLE,
            description = "A powerful fish has appeared in the ocean! Hurry before it's gone.",
            color = EMBED_COLOR,
            fields = {
                { name = "Fish", value = "**" .. fishName .. "**", inline = true },
                { name = "Percentage", value = "**" .. tostring(value) .. "%**", inline = true }
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
            footer = { text = FOOTER }
        }}
    }

    if DEBUG then
        print("[DEBUG] Preparing webhook for: " .. fishName .. " (" .. value .. "%)")
    end

    local success, err = pcall(function()
        HttpService:PostAsync(WEBHOOK_URL, HttpService:JSONEncode(data), Enum.HttpContentType.ApplicationJson)
    end)

    if success then
        print("[FishNotifier] Webhook SENT successfully â†’ " .. fishName .. " (" .. value .. "%)")
    else
        warn("[FishNotifier] Webhook FAILED: " .. tostring(err))
    end
end

RunService.Heartbeat:Connect(function()
    local text = getText()
    if not text or text == "" then return end

    local value, fishName = extractPercentageAndFish(text)
    if value then
        sendWebhook(value, fishName)
    end
end)
