-- TEMP DEBUG VERSION - NO WEBHOOK SENDING - EXTREME LOGGING
-- Goal: find exactly where 'nil with number' happens

print("[DEBUG START] Loading script - no webhook will be sent")

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local THRESHOLD = 50
local MAX_INDEX = 150
local SCAN_INTERVAL = 90

-- Folders
print("[DEBUG] Waiting for FrameWork_WorkSpace...")
local frameWork = workspace:WaitForChild("FrameWork_WorkSpace", 10)
if not frameWork then
    warn("[FATAL] FrameWork_WorkSpace not found!")
    return
end

print("[DEBUG] Waiting for FishPPPart...")
local fishPPPart = frameWork:WaitForChild("FishPPPart", 10)
if not fishPPPart then
    warn("[FATAL] FishPPPart not found!")
    return
end

print("[DEBUG] Waiting for shelf parent...")
local shelfParent = frameWork:WaitForChild("\232\180\167\230\158\182", 10)
if not shelfParent then
    warn("[FATAL] Shelf parent '\232\180\167\230\158\182' not found!")
    return
end

-- Get folders safely
local folder1 = shelfParent:FindFirstChild("Folder1")
local folder2 = shelfParent:FindFirstChild("Folder2")
local folder3 = shelfParent:FindFirstChild("Folder3")

print("[DEBUG] Folder1: " .. tostring(folder1))
print("[DEBUG] Folder2: " .. tostring(folder2))
print("[DEBUG] Folder3: " .. tostring(folder3))

local folders = {}
if folder1 then table.insert(folders, {obj = folder1, name = "Folder1"}) end
if folder2 then table.insert(folders, {obj = folder2, name = "Folder2"}) end
if folder3 then table.insert(folders, {obj = folder3, name = "Folder3"}) end

if #folders == 0 then
    warn("[FATAL] No valid folders found!")
    return
end

print("[DEBUG] Found " .. #folders .. " valid shelf folders")

-- Your 17 positions (only these are scanned)
local shelfPositions = {
    {folderName = "Folder1", index = 8,   label = "Gran Maja"},
    {folderName = "Folder1", name = "\229\177\149\229\143\176", label = "Hammerhead"},
    {folderName = "Folder1", index = 14,  label = "Sea Dweller"},
    {folderName = "Folder1", index = 12,  label = "Zombie Fish"},
    {folderName = "Folder1", index = 10,  label = "King Squid"},
    {folderName = "Folder1", index = 15,  label = "Sea Reaper"},
    {folderName = "Folder1", index = 7,   label = "BLOOP"},
    {folderName = "Folder1", index = 6,   label = "Julia Beast"},
    {folderName = "Folder1", index = 5,   label = "Ningen"},
    {folderName = "Folder1", index = 3,   label = "Plesiosaurus"},
    {folderName = "Folder1", name = "\229\177\149\229\143\1761", label = "SCP3000"},
    {folderName = "Folder2", index = 6,   label = "Megalodon"},
    {folderName = "Folder2", name = "\230\158\182\229\173\144", label = "Julia Beast"},
    {folderName = "Folder3", index = 22,  label = "Shark Girl"},
    {folderName = "Folder3", index = 21,  label = "Shark Boy"},
    {folderName = "Folder3", index = 19,  label = "Bone Shark"},
    {folderName = "Folder3", index = 18,  label = "Sea Eater"},
}

print("[DEBUG] Defined " .. #shelfPositions .. " target positions")

-- Get prompt text safely
local function getPromptInfo(part)
    if not part then
        print("[DEBUG] getPromptInfo: part is nil")
        return nil, nil
    end

    print("[DEBUG] Checking part: " .. part:GetFullName())

    local prompt = part:FindFirstChild("PPPart_PP")
    if not prompt then
        print("[DEBUG] No PPPart_PP found")
        return nil, nil
    end

    if not prompt:IsA("ProximityPrompt") then
        print("[DEBUG] PPPart_PP is not ProximityPrompt")
        return nil, nil
    end

    local name = prompt.ObjectText or ""
    local action = prompt.ActionText or ""

    print("[DEBUG] Prompt found")
    print("   ObjectText: '" .. name .. "'")
    print("   ActionText: '" .. action .. "'")

    return name, action
end

-- Extract percentage
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then
        print("[DEBUG] No text for percentage")
        return nil
    end

    print("[DEBUG] Parsing text: " .. text:sub(1, 100))

    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }

    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v then
                print("[DEBUG] Matched pattern '" .. pat .. "' → " .. v)
                if v >= THRESHOLD then
                    print("[DEBUG] Accepted ≥ " .. THRESHOLD .. "%")
                    return v
                else
                    print("[DEBUG] Rejected < " .. THRESHOLD .. "%")
                end
            end
        end
    end

    print("[DEBUG] No valid percentage")
    return nil
end

-- Manual test scan on start
print("[DEBUG TEST SCAN] Running once at start...")

for _, entry in ipairs(shelfPositions) do
    print("[DEBUG POSITION] " .. entry.label)

    local folder = nil
    if entry.folderName == "Folder1" then folder = folder1 end
    if entry.folderName == "Folder2" then folder = folder2 end
    if entry.folderName == "Folder3" then folder = folder3 end

    if not folder then
        print("  → Folder missing")
        continue
    end

    print("  Folder: " .. folder:GetFullName())

    local part = nil
    if entry.index then
        local children = folder:GetChildren()
        if not children or type(children) ~= "table" then
            print("  → GetChildren() returned nil or not table")
            continue
        end
        if #children < entry.index + 1 then
            print("  → Index " .. entry.index .. " out of bounds (only " .. #children .. " children)")
            continue
        end
        part = children[entry.index + 1]
    elseif entry.name then
        part = folder:FindFirstChild(entry.name)
        if not part then
            print("  → Named child '" .. entry.name .. "' not found")
        end
    end

    if not part then
        print("  → Part not found")
        continue
    end

    print("  Part found: " .. part:GetFullName())

    local name, action = getPromptInfo(part)
    if name then
        local percent = extractPercentage(name, action)
        if percent then
            print("  → DETECTED: " .. name .. " @ " .. percent .. "%")
        else
            print("  → No valid percentage")
        end
    else
        print("  → No valid prompt")
    end
end

print("[DEBUG TEST SCAN] Finished. Check output above for details.")

-- Periodic scan (optional, comment out if only want one test)
--[[
local lastScan = 0

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    print("[PERIODIC SCAN START]")
    -- (copy the same scan logic as above)
    print("[PERIODIC SCAN END]")
end)
--]]

print("[DEBUG MODE] Script loaded - look at output for what it sees")
