-- AutoFish Notifier - Scan FishPPPart indices 0-150 for "Able" attribute
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local WEBHOOK_URL = "https://discord.com/api/webhooks/1469813322936356956/7vOLfjATJUvnwcKcUACeMOpC6-KssMk6P6pSsNzajaJXHRWY5PhPuq9rE2WJQsNJ2u2n"
local THRESHOLD = 50
local SCAN_INTERVAL = 90
local DEBUG = true

-- Get FrameWork_WorkSpace
local workspaceFrame = workspace:WaitForChild("FrameWork_WorkSpace", 10)
if not workspaceFrame then
    error("FrameWork_WorkSpace not found!")
end

-- FishPPPart location
local fishPPPart = workspaceFrame:WaitForChild("FishPPPart", 10)
if not fishPPPart then
    error("FishPPPart folder not found!")
end

-- Get all three folders
local folders = {
    fishPPPart:WaitForChild("Folder1", 10),
    fishPPPart:WaitForChild("Folder2", 10),
    fishPPPart:WaitForChild("Folder3", 10)
}

-- Check if folders exist
for i, folder in ipairs(folders) do
    if not folder then
        error("Folder" .. i .. " not found in FishPPPart!")
    end
end

print("[FishScanner] Found all 3 FishPPPart folders")

-- Your desired fish types (case-insensitive partial match)
local wantedFishTypes = {
    "sea dweller",
    "scp3000", "scp-300", "scp 300", "scp300",
    "plesiosaurus",
    "hammerhead shark", "hammerhead",
    "bloop",
    "el gran maja", "gran maja",
    "julia beast",
    "ningen",
    "megalodon",
    "zombie fish",
    "sea eater",
    "bone shark", "boneshark",
    "shark girl",
    "shark boy",
    "king squid",
    "sea reaper"
}

-- Function to check if fish is wanted
local function isWantedFish(name)
    if not name then return false end
    local lower = name:lower()
    for _, w in ipairs(wantedFishTypes) do
        if lower:find(w:lower(), 1, true) then
            return true
        end
    end
    return false
end

-- Extract percentage from name and action text
local function extractPercentage(name, action)
    local text = (name or "") .. " " .. (action or "")
    if text == "" then return nil end
    local clean = text:lower():gsub("%s+", "")
    local patterns = {
        "(%d+%.?%d*)%%",
        "(%d+)%%",
        "(%d+%.?%d*) ?percent",
        "%%(%d+)"
    }
    for _, pat in ipairs(patterns) do
        local numStr = clean:match(pat)
        if numStr then
            local v = tonumber(numStr)
            if v and v >= THRESHOLD then return v end
        end
    end
    return nil
end

-- Check if fish has "Able" attribute enabled (capital A)
local function isAbleEnabled(fishModel)
    if not fishModel then return false end
    
    -- Check for "Able" attribute (capital A)
    local ableAttr = fishModel:GetAttribute("Able")
    if ableAttr ~= nil then
        if type(ableAttr) == "boolean" then
            return ableAttr == true
        elseif type(ableAttr) == "string" then
            local val = ableAttr:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif type(ableAttr) == "number" then
            return ableAttr > 0
        end
    end
    
    -- Also check lowercase "able" just in case
    local ableAttrLower = fishModel:GetAttribute("able")
    if ableAttrLower ~= nil then
        if type(ableAttrLower) == "boolean" then
            return ableAttrLower == true
        elseif type(ableAttrLower) == "string" then
            local val = ableAttrLower:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif type(ableAttrLower) == "number" then
            return ableAttrLower > 0
        end
    end
    
    -- Check for "able" child object (backward compatibility)
    local ableChild = fishModel:FindFirstChild("able")
    if ableChild then
        if ableChild:IsA("BoolValue") then
            return ableChild.Value == true
        elseif ableChild:IsA("StringValue") then
            local val = ableChild.Value:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif ableChild:IsA("NumberValue") then
            return ableChild.Value > 0
        end
    end
    
    -- Check for "Able" child object (capital A)
    local AbleChild = fishModel:FindFirstChild("Able")
    if AbleChild then
        if AbleChild:IsA("BoolValue") then
            return AbleChild.Value == true
        elseif AbleChild:IsA("StringValue") then
            local val = AbleChild.Value:lower()
            return val == "true" or val == "1" or val == "enabled" or val == "yes"
        elseif AbleChild:IsA("NumberValue") then
            return AbleChild.Value > 0
        end
    end
    
    return false
end

-- Get fish info from model
local function getFishInfo(fishModel)
    if not fishModel then return nil, nil, nil end
    
    -- Get prompt info
    local prompt = fishModel:FindFirstChild("PPPart_PP")
    if not prompt or not prompt:IsA("ProximityPrompt") then
        return nil, nil, nil
    end
    
    local name = prompt.ObjectText or fishModel.Name
    local action = prompt.ActionText or ""
    
    -- Check if Able attribute is enabled
    local enabled = isAbleEnabled(fishModel)
    
    return name, action, enabled
end

-- Send all detected fish as one webhook message
local function SendCombinedWebhook(detectedFish)
    if #detectedFish == 0 then return end
    
    -- Sort by percentage (highest first)
    table.sort(detectedFish, function(a, b)
        return a.percent > b.percent
    end)
    
    -- Create the message
    local lines = {}
    for i, fish in ipairs(detectedFish) do
        table.insert(lines, i .. ". **" .. fish.name .. "** - **" .. fish.percent .. "%**")
    end
    
    local message = "**Fish Ready for Collection (" .. #detectedFish .. " total):**\n" .. table.concat(lines, "\n")
    local payload = {content = message}
    local body = HttpService:JSONEncode(payload)
    
    if DEBUG then 
        print("[WEBHOOK] Sending combined message with " .. #detectedFish .. " fish:")
        for _, fish in ipairs(detectedFish) do
            print("  • " .. fish.name .. " @ " .. fish.percent .. "%")
        end
    end
    
    -- Send the webhook
    local success, response = pcall(function()
        return HttpService:PostAsync(WEBHOOK_URL, body, Enum.HttpContentType.ApplicationJson)
    end)
    
    if success then
        print("[WEBHOOK] ✓ Sent combined message with " .. #detectedFish .. " fish")
    else
        warn("[WEBHOOK] ✗ Failed: " .. tostring(response))
        
        -- Try request if available
        if request then
            local success2 = pcall(function()
                request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = body
                })
            end)
            if success2 then
                print("[WEBHOOK] ✓ Sent via request method")
            end
        end
    end
end

-- Main scan function - collects all fish with Able=true
local function scanFishPPPart()
    if DEBUG then print("\n" .. string.rep("=", 60)) end
    if DEBUG then print("[SCAN START] Scanning FishPPPart for fish with Able=true...") end
    
    local totalScanned = 0
    local enabledCount = 0
    local wantedCount = 0
    local detectedFish = {}
    
    for folderIndex, folder in ipairs(folders) do
        if DEBUG then print("\n[SCAN] Folder" .. folderIndex .. " (" .. folder.Name .. ")") end
        
        -- Scan all children (not just 0-150)
        local children = folder:GetChildren()
        if DEBUG then print("[INFO] " .. folder.Name .. " has " .. #children .. " children") end
        
        -- Scan indices 0 to 150 (or all if less)
        local maxIndex = math.min(150, #children - 1)
        
        for i = 0, maxIndex do
            totalScanned = totalScanned + 1
            
            -- Get child at index i
            local fishModel = children[i + 1]
            
            -- Get fish info
            local name, action, enabled = getFishInfo(fishModel)
            
            if name and enabled then
                enabledCount = enabledCount + 1
                
                -- Check if it's a wanted fish
                if isWantedFish(name) then
                    wantedCount = wantedCount + 1
                    
                    -- Extract percentage
                    local percent = extractPercentage(name, action)
                    if percent then
                        -- Add to detected fish list
                        table.insert(detectedFish, {
                            name = name,
                            percent = percent,
                            folder = folder.Name,
                            index = i
                        })
                        
                        if DEBUG then
                            print("[DETECT] ✓ " .. name .. " @ " .. percent .. "% (Index " .. i .. " in " .. folder.Name .. ")")
                        end
                    elseif DEBUG then
                        print("[NO-PERCENT] " .. name .. " (no valid percentage)")
                    end
                elseif DEBUG then
                    print("[NOT-WANTED] " .. name .. " (Able enabled but not wanted)")
                end
            elseif DEBUG and i % 40 == 0 and i > 0 then
                -- Print progress every 40 indices
                print("[PROGRESS] Folder" .. folderIndex .. ": Scanned " .. i .. "/" .. maxIndex .. " indices")
            end
        end
    end
    
    -- Send combined webhook if any fish found
    if #detectedFish > 0 then
        SendCombinedWebhook(detectedFish)
    end
    
    if DEBUG then
        print("\n[SCAN END] Summary:")
        print("  Total indices scanned: " .. totalScanned)
        print("  Models with Able=true: " .. enabledCount)
        print("  Wanted fish with Able=true: " .. wantedCount)
        print("  Fish ready for collection: " .. #detectedFish)
        print(string.rep("=", 60))
    end
end

-- Start scanning
local lastScan = 0
local isScanning = false

RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    if isScanning then return end
    
    isScanning = true
    lastScan = now
    
    scanFishPPPart()
    isScanning = false
end)

-- Initial info
print("\n" .. string.rep("=", 50))
print("[FishScanner] Active!")
print("  • Scanning: FishPPPart.Folder1/2/3")
print("  • Checking: Attribute 'Able' = true")
print("  • Threshold: ≥ " .. THRESHOLD .. "%")
print("  • Scan interval: " .. SCAN_INTERVAL .. " seconds")
print("  • Output: Combined webhook message")
print("  • Wanted fish types: " .. #wantedFishTypes)
print(string.rep("=", 50))

-- Send startup notification
wait(2)
local startupMsg = "**[STARTUP]** FishScanner active! Will send combined updates every " .. SCAN_INTERVAL .. " seconds."
local payload = {content = startupMsg}
local body = HttpService:JSONEncode(payload)

pcall(function()
    HttpService:PostAsync(WEBHOOK_URL, body, Enum.HttpContentType.ApplicationJson)
    print("[WEBHOOK] Startup message sent")
end)

-- Initial scan
wait(5)
scanFishPPPart()
